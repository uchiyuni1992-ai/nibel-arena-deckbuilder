<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ニベルアリーナ デッキビルダー（非公式）</title>

<style>
body{
  font-family:sans-serif;
  padding:10px;
  max-width:1100px;
  margin:0 auto;
  box-sizing:border-box;
}
h1{font-size:20px;margin-bottom:8px;}
#layout{display:flex;flex-wrap:wrap;gap:12px;}
#searchArea{flex:2 1 340px;min-width:300px;}
#deckArea{
  flex:1 1 260px;
  min-width:260px;
  border:1px solid #ccc;
  border-radius:4px;
  padding:8px;
  background:#f5f5f5;
}
#q{
  width:100%;
  padding:8px;
  font-size:16px;
  box-sizing:border-box;
}

/* 検索結果カード（左側） */
.card-row{
  border:1px solid #ccc;
  padding:8px;
  margin:8px 0;
  display:flex;
  gap:8px;
  background:#fafafa;
  border-radius:4px;
}
.card-row img{
  width:120px;          /* ★ここが検索結果サムネのサイズ */
  height:auto;
  max-height:180px;
  object-fit:cover;
  border:1px solid #999;
  background:#eee;
}

small{color:#666;}
.count{margin-top:6px;font-size:12px;color:#555;}
button{cursor:pointer;}
.btn-row button{
  margin-right:4px;
  margin-top:4px;
  font-size:11px;
  padding:3px 6px;
}

/* フィルターUI */
.filters{
  margin:8px 0;
  font-size:12px;
}
.filter-block{margin-bottom:4px;}
#colorFilter label{margin-right:8px;}
#typeFilter label{margin-right:8px;}
.filter-label{
  font-weight:bold;
  margin-right:4px;
}

/* デッキ側 */
#deckList, #leaderSlot{font-size:13px;}

.badge{
  display:inline-block;
  padding:1px 4px;
  border-radius:3px;
  font-size:11px;
  background:#ddd;
  margin-left:4px;
}
.badge-leader{background:#ffcc80;}
.badge-over{background:#ffcccc;color:#b00020;font-weight:bold;}

/* リーダー欄 */
.leader-row{
  display:flex;
  align-items:center;
  gap:6px;
}
.leader-thumb{
  width:60px;          /* ★リーダーサムネ */
  height:auto;
  object-fit:cover;
  border:1px solid #999;
  background:#eee;
  border-radius:2px;
}

/* デッキ欄カード行 */
.deck-card-row{
  display:flex;
  align-items:center;
  padding:3px 0;
  border-bottom:1px solid #ddd;
  gap:6px;
}
.deck-card-left{
  display:flex;
  align-items:center;
  gap:6px;
  flex:1;
  min-width:0; /* スマホでエリプシス効かせる */
}
.deck-card-thumb{
  width:40px;          /* ★デッキサムネ */
  height:auto;
  object-fit:cover;
  border:1px solid #999;
  background:#eee;
  border-radius:2px;
}
.deck-card-name{
  font-size:12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.deck-card-count{
  margin:0 4px;
  white-space:nowrap;
}

@media (max-width:700px){
  #layout{flex-direction:column;}

  /* スマホではデッキ欄を上に固定して常時表示 */
  #deckArea{
    order:-1;
    position:sticky;
    top:0;
    z-index:10;
    max-height:32vh;
    overflow:auto;
    padding:6px;
  }

  /* デッキ側の余白を少し詰める */
  #deckArea h2{ margin:2px 0; }
  #deckArea hr{ margin:6px 0; }

  /* デッキ操作ボタンを押しやすく */
  #deckArea button{
    font-size:13px;
    padding:6px 10px;
  }
  .deck-card-row button{
    font-size:16px !important;
    padding:6px 10px;
  }
}

/* PCでもデッキ欄を固定表示（スクロールで隠れない） */
@media (min-width:701px){
  #deckArea{
    position:sticky;
    top:10px;
    align-self:flex-start;
    max-height:calc(100vh - 20px);
    overflow:auto;
  }
}

/* デッキ欄：グリッド表示 */
.deck-grid{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:6px;
  margin-top:6px;
}
@media (min-width:701px){
  .deck-grid{ grid-template-columns:repeat(5, 1fr); }
}
.deck-cell{
  position:relative;
}
.deck-cell img{
  width:100%;
  display:block;
  border:1px solid #999;
  background:#eee;
  border-radius:2px;
}
.deck-badge{
  position:absolute;
  top:4px;
  right:4px;
  background:rgba(0,0,0,0.75);
  color:#fff;
  font-size:12px;
  font-weight:bold;
  padding:2px 6px;
  border-radius:999px;
}
.deck-cell-controls{
  display:flex;
  gap:4px;
  margin-top:4px;
}
.deck-cell-controls button{
  flex:1;
  font-size:14px;
  padding:4px 0;
}

</style>
</head>

<body>
<h1>ニベルアリーナ デッキビルダー（非公式）</h1>

<p style="font-size:13px;">
カード名を入力して検索し、デッキ構築ができます。<br>
・リーダー：1枚<br>
・デッキ：40枚（超過時は赤表示）<br>
・同カードナンバー：3枚まで（超過時は赤表示）
</p>

<div id="layout">

  <!-- 検索エリア -->
  <div id="searchArea">
    <input id="q" placeholder="例：レッドフード / 紅蓮 / クラウン" />

    <!-- 色 & 弾フィルター -->
    <div class="filters">
      <div class="filter-block">
        <span class="filter-label">色フィルター：</span>
        <div id="colorFilter">
          <label><input type="checkbox" value="赤">赤</label>
          <label><input type="checkbox" value="緑">緑</label>
          <label><input type="checkbox" value="紫">紫</label>
          <label><input type="checkbox" value="青">青</label>
          <label><input type="checkbox" value="黄">黄</label>
          <!-- 必要ならここに増やす（緑 / 紫 / 無 / 多色 など） -->
        </div>
      </div>

      <div class="filter-block">
        <label class="filter-label" for="setFilter">弾フィルター：</label>
        <select id="setFilter">
          <option value="">すべての弾</option>
          <option value="BT01">BT01</option>
          <option value="BT02">BT02</option>
          <option value="ST01">ST01</option>
          <option value="ST02">ST02</option>
          <option value="ST03">ST03</option>
          <option value="ST04">ST04</option>
          <option value="ST05">ST05</option>
          <!-- 新しい弾を追加したらここに option を足す -->
        </select>
      </div>
    

      <div class="filter-block">
        <span class="filter-label">種類フィルター：</span>
        <div id="typeFilter">
          <label><input type="checkbox" value="LEADER">LEADER</label>
          <label><input type="checkbox" value="UNIT">UNIT</label>
          <label><input type="checkbox" value="ITEM">ITEM</label>
          <label><input type="checkbox" value="SKILL">SKILL</label>
        </div>
      </div>

</div>

    <div class="count" id="searchCount"></div>
    <div id="list"></div>
  </div>

  <!-- デッキエリア -->
  <div id="deckArea">
    <div>
      <h2 style="font-size:16px;margin:4px 0;">リーダー</h2>
      <div id="leaderSlot">未選択</div>
      <button id="clearLeaderBtn" style="margin-top:4px;font-size:11px;">リーダー解除</button>
    </div>

    <hr>

    <div>
      <h2 style="font-size:16px;margin:4px 0;">デッキ</h2>
      <div id="deckCount" class="count"></div>
      <div id="deckList"></div>
      <button id="clearDeckBtn" style="margin-top:4px;font-size:11px;">デッキをリセット</button>
      <button id="toggleDeckViewBtn" style="margin-top:4px;font-size:11px;">表示：リスト</button>
      <button id="exportDeckImgBtn" style="margin-top:4px;font-size:11px;">画像で保存</button>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>

// ====== 設定 ======
const DECK_LIMIT = 40;   // デッキ目安枚数
const COPY_LIMIT = 3;    // 同名カード目安上限
const COLOR_ORDER = ['赤', '緑', '紫', '青', '黄', '無', '多色'];

// ====== 状態 ======
let cards = [];          // CSVから読み込んだカード
let leaderId = null;     // 現在のリーダー
const deck = {};         // { id: 枚数 }


let deckView = localStorage.getItem('deckView') || 'list'; // 'list' or 'grid'
function updateDeckViewBtn(){
  if (!toggleDeckViewBtn) return;
  toggleDeckViewBtn.textContent = '表示：' + (deckView === 'grid' ? 'グリッド' : 'リスト');
}


// ====== DOM取得 ======
const input        = document.getElementById('q');
const list         = document.getElementById('list');
const searchCountEl= document.getElementById('searchCount');
const deckCountEl  = document.getElementById('deckCount');
const deckListEl   = document.getElementById('deckList');
const leaderSlotEl = document.getElementById('leaderSlot');
const clearLeaderBtn = document.getElementById('clearLeaderBtn');
const clearDeckBtn   = document.getElementById('clearDeckBtn');
const colorFilterEl  = document.getElementById('colorFilter');
const setFilterEl    = document.getElementById('setFilter');
const typeFilterEl   = document.getElementById('typeFilter');
const exportDeckImgBtn = document.getElementById('exportDeckImgBtn');
const toggleDeckViewBtn = document.getElementById('toggleDeckViewBtn');
const exportOverlay    = document.getElementById('exportOverlay');

// ====== イベント ======
input.addEventListener('input', renderSearch);
clearLeaderBtn.addEventListener('click', () => {
  leaderId = null;
  renderDeck();
  renderSearch();
});
clearDeckBtn.addEventListener('click', () => {
  if (!confirm('デッキとリーダーをすべてクリアしますか？')) return;
  leaderId = null;
  for (const k in deck) delete deck[k];
  renderDeck();
  renderSearch();
});
colorFilterEl.addEventListener('change', renderSearch);
setFilterEl.addEventListener('change', renderSearch);
if (typeFilterEl) typeFilterEl.addEventListener('change', renderSearch);
if (exportDeckImgBtn) exportDeckImgBtn.addEventListener('click', exportDeckAsImage);
if (toggleDeckViewBtn) toggleDeckViewBtn.addEventListener('click', () => {
  deckView = (deckView === 'list') ? 'grid' : 'list';
  localStorage.setItem('deckView', deckView);
  updateDeckViewBtn();
  renderDeck();
});

// ====== CSV読み込み ======
async function loadCardsFromCsv() {
  const res = await fetch('cards.csv'); // index.html と同じフォルダ
  if (!res.ok) throw new Error('cards.csv の読み込みに失敗: ' + res.status);
  const text = await res.text();
  return parseCsv(text);
}

function parseCsv(csvText) {
  // BOM除去
  csvText = String(csvText || '').replace(/^\uFEFF/, '');

  // CSV全体を1文字ずつ走査して、引用符内の改行・カンマを正しく扱う
  const rows = [];
  let row = [];
  let cur = '';
  let inQuotes = false;

  for (let i = 0; i < csvText.length; i++){
    const ch = csvText[i];

    if (ch === '"'){
      // "" は " を意味する
      if (inQuotes && csvText[i + 1] === '"'){
        cur += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && ch === ','){
      row.push(cur);
      cur = '';
      continue;
    }

    if (!inQuotes && (ch === '\n' || ch === '\r')){
      // CRLF対応
      if (ch === '\r' && csvText[i + 1] === '\n') i++;
      row.push(cur);
      cur = '';
      // 空行はスキップ
      if (row.some(v => String(v).trim() !== '')) rows.push(row);
      row = [];
      continue;
    }

    cur += ch;
  }

  // 最終行
  row.push(cur);
  if (row.some(v => String(v).trim() !== '')) rows.push(row);

  if (rows.length === 0) return [];

  const headers = rows[0].map(h => String(h || '').trim());
  return rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = String(r[idx] ?? '').trim();
    });
    return obj;
  });
}



// 画像URLを正規化（/images/... でも pages 配下を指すようにする）
function baseDir(){
  return location.origin + location.pathname.replace(/[^\/]*$/, "");
}
function normalizeImageUrl(u){
  if (!u) return "";
  u = String(u).trim().replace(/\\/g, "/");
  if (/^https?:\/\//i.test(u) || u.startsWith("data:")) return u;

  // /images/... を「サイト配下(images/...)」へ補正
  if (u.startsWith("/images/")) return baseDir() + u.slice(1);
  if (u.startsWith("/image/"))  return baseDir() + "images/" + u.split("/").pop(); // 念のため旧 image フォルダも救済

  if (u.startsWith("./")) u = u.slice(2);
  return baseDir() + u.replace(/^\//, "");
}
// GoogleドライブのサムネURL
function driveThumb(url) {
  const u = normalizeImageUrl(url);
  if (!u) return "";
  // Google Drive のときだけ thumbnail に変換
  const m = u.match(/id=([^&]+)/);
  if (!m) return u;
  const id = m[1];
  return "https://drive.google.com/thumbnail?id=" + id + "&sz=w400";
}

function currentDeckCount() {
  return Object.values(deck).reduce((a,b)=>a+b,0);
}

function colorSortKey(card){
  const idx = COLOR_ORDER.indexOf(card.color);
  return idx === -1 ? 999 : idx;
}

// ====== デッキ操作 ======
function addToDeck(cardId){
  const cur = deck[cardId] || 0;
  deck[cardId] = cur + 1;
  renderDeck();
  renderSearch();
}

function removeFromDeck(cardId){
  const cur = deck[cardId] || 0;
  if (cur <= 0) return;
  if (cur === 1) delete deck[cardId];
  else deck[cardId] = cur - 1;
  renderDeck();
  renderSearch();
}

function setLeader(cardId){
  const c = cards.find(x => x.id === cardId);
  const t = String(c?.type || '').toUpperCase();
  if (t && t !== 'LEADER'){
    alert('このカードはリーダーにできません（type=LEADER のみ）');
    return;
  }
  leaderId = cardId;
  renderDeck();
  renderSearch();
}

// ====== 検索結果描画 ======
function renderSearch(){
  const q = input.value.trim().toLowerCase();
  list.innerHTML = "";

  if (!cards || cards.length === 0){
    searchCountEl.textContent = "カードデータが読み込まれていません。cards.csv を確認してください。";
    return;
  }

  // 今チェックされている色
  const selectedColors = Array.from(
    colorFilterEl.querySelectorAll('input[type="checkbox"]:checked')
  ).map(cb => cb.value);

  // 今選択されている弾
  const selectedSet = setFilterEl.value;

  // 今チェックされている種類（LEADER/UNIT/ITEM/SKILL）
  const selectedTypes = typeFilterEl
    ? Array.from(typeFilterEl.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
    : [];

  // 絞り込み
  const filtered = cards.filter(c => {
    // テキスト検索（名前 + 効果）
    if (q){
      // NOTE: 検索対象は name + text の形を維持（将来text実装時に復帰しやすい）
      const hay = ((c.name || "") + " " + (c.text || "")).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    // 色フィルター
    if (selectedColors.length > 0){
      if (!selectedColors.includes(c.color)) return false;
    }
    // 弾フィルター
    if (selectedSet){
      if (c.set !== selectedSet) return false;
    }
    // 種類フィルター
    if (selectedTypes.length > 0){
      const t = String(c.type || '').toUpperCase();
      if (!selectedTypes.includes(t)) return false;
    }
    return true;
  });

  // 並び順：色 → 弾 → 番号
  filtered.sort((a,b)=>{
    const ca = colorSortKey(a);
    const cb = colorSortKey(b);
    if (ca !== cb) return ca - cb;

    if ((a.set||"") !== (b.set||"")){
      return (a.set||"").localeCompare(b.set||"");
    }

    return (Number(a.number)||0) - (Number(b.number)||0);
  });

  searchCountEl.textContent = "検索ヒット: " + filtered.length + " / 全" + cards.length + "枚";

  if (filtered.length === 0){
    const div = document.createElement('div');
    div.textContent = "該当するカードがありません。";
    list.appendChild(div);
    return;
  }

  filtered.forEach(c => {
    const div = document.createElement('div');
    div.className = "card-row";

    const thumb = driveThumb(c.image);
    if (thumb){
      const img = document.createElement('img');
      img.src = thumb;
      img.alt = c.name || "";
      img.onerror = function(){ this.style.display = "none"; };
      div.appendChild(img);
    }

    const info = document.createElement('div');
    let badges = "";
    if (leaderId === c.id){
      badges += '<span class="badge badge-leader">リーダー</span>';
    }
    const deckCount = deck[c.id] || 0;
    if (deckCount > 0){
      const over = deckCount > COPY_LIMIT;
      badges += '<span class="badge' + (over ? ' badge-over' : '') + '">デッキ ' + deckCount + '枚</span>';
    }
    const rawUrl = normalizeImageUrl(c.image);
    const linkHtml = rawUrl
      ? '<div><a href="' + rawUrl + '" target="_blank" rel="noopener">元画像を開く</a></div>'
      : "";

    info.innerHTML =
      '<b>' + (c.name || "(名称なし)") + '</b>' + badges + '<br>'
      // NOTE: 効果テキスト(text)は将来実装予定のため、いったん表示しない
      // + (c.text || "") + '<br>'
      + '<small>' + (c.id || "") + '</small>'
      + linkHtml;

    const btnRow = document.createElement('div');
    btnRow.className = "btn-row";

    const addBtn = document.createElement('button');
    addBtn.textContent = "+デッキ";
    addBtn.onclick = () => addToDeck(c.id);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = "−デッキ";
    removeBtn.onclick = () => removeFromDeck(c.id);

    // リーダーにできるのは type=LEADER のみ
    const t = String(c.type || '').toUpperCase();
    let leaderBtn = null;
    if (t === 'LEADER'){
      leaderBtn = document.createElement('button');
      leaderBtn.textContent = "リーダーにする";
      leaderBtn.onclick = () => setLeader(c.id);
    }

    btnRow.appendChild(addBtn);
    btnRow.appendChild(removeBtn);
    if (leaderBtn) btnRow.appendChild(leaderBtn);

    info.appendChild(btnRow);
    div.appendChild(info);
    list.appendChild(div);
  });
}

// ====== デッキ描画 ======
function renderDeck(){
  // リーダー表示
  if (!leaderId){
    leaderSlotEl.textContent = "未選択";
  } else {
    const card = cards.find(c => c.id === leaderId);
    if (!card){
      leaderSlotEl.textContent = leaderId + "（データなし）";
    } else {
      const thumb = driveThumb(card.image);
      let html = '<div class="leader-row">';
      if (thumb){
        html += '<img class="leader-thumb" src="' + thumb + '" alt="' + (card.name || "") + '">';
      }
      html += '<div><b>' + (card.name || "(名称なし)") + '</b><br>'
           +  '<small>' + card.id + '</small></div></div>';
      leaderSlotEl.innerHTML = html;
    }
  }

  // デッキ一覧
  deckListEl.innerHTML = "";
  const total = currentDeckCount();
  const overDeck = total > DECK_LIMIT;
  deckCountEl.innerHTML = "デッキ枚数: " + total + " / " + DECK_LIMIT
    + (overDeck ? ' <span class="badge-over">40枚超過</span>' : '');

  const ids = Object.keys(deck);
  if (ids.length === 0){
    const div = document.createElement('div');
    div.textContent = "デッキにカードがありません。";
    deckListEl.appendChild(div);
    return;
  }

  ids.sort();

  // === 表示切替：リスト / グリッド ===
  if (deckView === 'grid'){
    const grid = document.createElement('div');
    grid.className = 'deck-grid';

    ids.forEach(id => {
      const count = deck[id];
      const card = cards.find(c => c.id === id) || {id, name:""};

      const cell = document.createElement('div');
      cell.className = 'deck-cell';

      const thumb = driveThumb(card.image);
      if (thumb){
        const img = document.createElement('img');
        img.src = thumb;
        img.alt = card.name || "";
        img.onerror = function(){ this.style.display = "none"; };
        cell.appendChild(img);
      } else {
        const ph = document.createElement('div');
        ph.style.height = '80px';
        ph.style.border = '1px solid #999';
        ph.style.background = '#eee';
        cell.appendChild(ph);
      }

      const badge = document.createElement('div');
      badge.className = 'deck-badge';
      badge.textContent = String(count);
      cell.appendChild(badge);

      const controls = document.createElement('div');
      controls.className = 'deck-cell-controls';

      const minusBtn = document.createElement('button');
      minusBtn.textContent = "−";
      minusBtn.onclick = () => removeFromDeck(id);

      const plusBtn = document.createElement('button');
      plusBtn.textContent = "+";
      plusBtn.onclick = () => addToDeck(id);

      controls.appendChild(minusBtn);
      controls.appendChild(plusBtn);

      cell.appendChild(controls);
      grid.appendChild(cell);
    });

    deckListEl.appendChild(grid);
    return;
  }

  // === リスト表示（従来） ===
  ids.forEach(id => {
    const count = deck[id];
    const card = cards.find(c => c.id === id) || {id, name:""};

    const row  = document.createElement('div');
    row.className = "deck-card-row";

    const left = document.createElement('div');
    left.className = "deck-card-left";

    const thumb = driveThumb(card.image);
    if (thumb){
      const img = document.createElement('img');
      img.className = "deck-card-thumb";
      img.src = thumb;
      img.alt = card.name || "";
      img.onerror = function(){ this.style.display = "none"; };
      left.appendChild(img);
    }

    const nameSpan = document.createElement('span');
    nameSpan.className = "deck-card-name";
    nameSpan.textContent = (card.name || "(名称なし)") + " (" + card.id + ")";
    left.appendChild(nameSpan);

    const overCopy = count > COPY_LIMIT;
    const countSpan = document.createElement('span');
    countSpan.className = "deck-card-count";
    countSpan.innerHTML =
      count + '枚' + (overCopy ? ' <span class="badge-over">3枚超</span>' : '');

    const btns = document.createElement('span');
    const minusBtn = document.createElement('button');
    minusBtn.textContent = "−";
    minusBtn.style.fontSize = "11px";
    minusBtn.onclick = () => removeFromDeck(id);
    const plusBtn = document.createElement('button');
    plusBtn.textContent = "+";
    plusBtn.style.fontSize = "11px";
    plusBtn.onclick = () => addToDeck(id);
    btns.appendChild(minusBtn);
    btns.appendChild(plusBtn);

    row.appendChild(left);
    row.appendChild(countSpan);
    row.appendChild(btns);

    deckListEl.appendChild(row);
  });

}

function waitImagesLoaded(container, timeoutMs = 8000){
  const imgs = Array.from(container.querySelectorAll('img'));
  return new Promise(resolve => {
    let done = false;
    const timer = setTimeout(() => {
      if (done) return;
      done = true;
      resolve();
    }, timeoutMs);

    if (imgs.length === 0){
      clearTimeout(timer);
      done = true;
      resolve();
      return;
    }

    let loadedCount = 0;
    imgs.forEach(img => {
      const onFinish = () => {
        loadedCount++;
        if (loadedCount >= imgs.length && !done){
          clearTimeout(timer);
          done = true;
          resolve();
        }
      };
      if (img.complete) onFinish();
      else {
        img.onload = onFinish;
        img.onerror = onFinish;
      }
    });
  });
}

async function exportDeckAsImage(){
  if (exportOverlay) exportOverlay.style.display = 'flex';
  try {

    if (!exportDeckImgBtn) return;
  
    // 保存専用DOMを生成（スクロール無しで全カードを1枚に）
    const wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.color = '#000';
    wrap.style.padding = '16px';
    wrap.style.width = '360px';
    wrap.style.boxSizing = 'border-box';
    wrap.style.fontFamily = 'sans-serif';
  
    const title = document.createElement('div');
    // タイトル：リーダーの色＋リーダー名（例：赤レッドフード デッキ）
    let titleText = 'ニベルアリーナ デッキ';
    if (leaderId){
      const leader = cards.find(c => c.id === leaderId);
      if (leader){
        const color = (leader.color || '').trim();
        const name  = (leader.name  || '').trim();
        if (color && name) titleText = `${color}${name} デッキ`;
        else if (name)     titleText = `${name} デッキ`;
      }
    }
    title.textContent = titleText;
    title.style.fontSize = '18px';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '6px';
    wrap.appendChild(title);
  
    const meta = document.createElement('div');
    meta.style.fontSize = '12px';
    meta.style.marginBottom = '10px';
    const total = currentDeckCount();
    const now = new Date();
    meta.textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}　デッキ枚数：${total}`;
    wrap.appendChild(meta);
  
    function makeImg(src, w){
      const img = document.createElement('img');
      img.crossOrigin = "anonymous";
      img.referrerPolicy = "no-referrer";
      img.src = src;
      img.style.width = w + "px";
      img.style.border = "1px solid #999";
      img.style.background = "#eee";
      return img;
    }
  
    // リーダー
    if (leaderId){
      const leader = cards.find(c => c.id === leaderId);
      if (leader){
        const sec = document.createElement('div');
        sec.style.marginBottom = '10px';
        sec.innerHTML = `<div style="font-weight:bold;margin-bottom:4px;">リーダー</div>`;
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
  
        const thumb = driveThumb(leader.image);
        if (thumb) row.appendChild(makeImg(thumb, 64));
  
        const name = document.createElement('div');
        name.innerHTML = `<div>${leader.name || ""}</div><div style="font-size:11px;color:#555;">${leader.id || ""}</div>`;
        row.appendChild(name);
  
        sec.appendChild(row);
        wrap.appendChild(sec);
      }
    }
  
    const hr = document.createElement('hr');
    hr.style.margin = '8px 0';
    wrap.appendChild(hr);
  
      // デッキ（カードだけをグリッドで並べる）
    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = 'repeat(5, 1fr)'; // UA風：5列
    grid.style.gap = '6px';
    grid.style.marginTop = '8px';
  
    const ids = Object.keys(deck).sort();
    ids.forEach(id => {
      const card = cards.find(c => c.id === id);
      if (!card) return;
  
      const count = deck[id] || 0;
  
      const cell = document.createElement('div');
      cell.style.position = 'relative';
  
      const thumb = driveThumb(card.image);
      const img = document.createElement('img');
      img.crossOrigin = "anonymous";
      img.referrerPolicy = "no-referrer";
      img.src = thumb;
      img.style.width = '100%';
      img.style.display = 'block';
      img.style.border = '1px solid #999';
      img.style.background = '#eee';
      cell.appendChild(img);
  
      const badge = document.createElement('div');
      badge.textContent = String(count);
      badge.style.position = 'absolute';
      badge.style.top = '4px';
      badge.style.right = '4px';
      badge.style.background = 'rgba(0,0,0,0.75)';
      badge.style.color = '#fff';
      badge.style.fontSize = '12px';
      badge.style.fontWeight = 'bold';
      badge.style.padding = '2px 6px';
      badge.style.borderRadius = '999px';
      cell.appendChild(badge);
  
      grid.appendChild(cell);
    });
  
    wrap.appendChild(grid);
    // 画面外に配置してキャプチャ
    wrap.style.position = 'fixed';
    wrap.style.left = '-10000px';
    wrap.style.top = '0';
    document.body.appendChild(wrap);
  
    try{
      await waitImagesLoaded(wrap, 8000);
      const canvas = await html2canvas(wrap, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true
      });
  
      const a = document.createElement('a');
      const stamp =
        now.getFullYear() +
        String(now.getMonth()+1).padStart(2,'0') +
        String(now.getDate()).padStart(2,'0') +
        String(now.getHours()).padStart(2,'0') +
        String(now.getMinutes()).padStart(2,'0');
      a.download = `nibel_deck_${stamp}.png`;
      a.href = canvas.toDataURL('image/png');
      a.click();
    } finally {
      document.body.removeChild(wrap);
      if (exportOverlay) exportOverlay.style.display = 'none';
    }
  
  } catch(e){
    console.error(e);
    alert('画像生成中にエラーが発生しました');
  } finally {
    if (exportOverlay) exportOverlay.style.display = 'none';
  }
}

// ====== 初期化 ======
(async function init(){
  try{
    cards = await loadCardsFromCsv();
    // NOTE: 現在はCSVのtext（効果テキスト）を検索/表示に使わない運用。
    // 将来text検索を戻すときはこの1行を削除してください。
    // （renderSearch内の検索対象は name + text のまま残してあります）
    cards = cards.map(c => ({ ...c, text: "" }));
    updateDeckViewBtn();
    renderSearch();
    renderDeck();
  }catch(e){
    console.error(e);
    searchCountEl.textContent = 'カードリスト(cards.csv)の読み込みに失敗しました。パスとファイル名を確認してください。';
  }
})();

</script>

<!-- 画像生成中オーバーレイ -->
<div id="exportOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#222;
    color:#fff;
    padding:16px 20px;
    border-radius:8px;
    font-size:14px;
  ">
    画像を生成しています…
  </div>
</div>

</body>
</html>
